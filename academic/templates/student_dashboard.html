{% extends 'base.html' %}
{% load custom_filters %} 

{% block title %}{{ course.code }} Durumu{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold text-dark">
            <span class="text-primary">{{ course.code }}</span> - {{ course.name }}
        </h2>
        <p class="text-muted">Merhaba {{ student.first_name }}, işte performans durumun.</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="card bg-primary text-white shadow-sm">
            <div class="card-body p-3">
                <h6 class="text-uppercase small opacity-75">Genel Ortalama</h6>
                <h1 class="mb-0 fw-bold">{{ current_average }}</h1>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-0">
                <h5 class="fw-bold m-0"><i class="fas fa-list-ol me-2 text-warning"></i>Sınav Notların</h5>
            </div>
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Sınav</th>
                            <th>Etki</th>
                            <th>Tarih</th>
                            <th class="text-end pe-4">Puan</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exam in assessments %}
                        <tr>
                            <td class="ps-4 fw-bold">{{ exam.name }}</td>
                            <td><span class="badge bg-light text-secondary border">%{{ exam.weight }}</span></td>
                            <td class="small text-muted">{{ exam.date|date:"d M Y" }}</td>
                            <td class="text-end pe-4">
                                {% if exam.id in score_map %}
                                    {% with not_degeri=score_map|get_item:exam.id %}
                                        {% if not_degeri >= 50 %}
                                            <span class="fw-bold text-success">{{ not_degeri }}</span>
                                        {% else %}
                                            <span class="fw-bold text-danger">{{ not_degeri }}</span>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center text-muted py-4">Henüz sınav açıklanmamış.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white py-3 border-0">
                <h5 class="fw-bold m-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Sınıf Kıyaslaması</h5>
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <p class="text-center text-muted small mt-2">
                    Kendi notların ile sınıf ortalamasının karşılaştırması.
                </p>
            </div>
        </div>

    </div>

    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 border-0">
                <h5 class="fw-bold m-0"><i class="fas fa-bullseye me-2 text-danger"></i>Kazanım Analizi (LO)</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="radarChart"></canvas>
                </div>
                
                <hr class="my-4">
                <h6 class="fw-bold text-dark mb-3">Detaylı Başarı Durumu</h6>
                
                <div class="v-stack gap-3">
                    {% for lo in lo_details %}
                    <div>
                        <div class="d-flex justify-content-between small mb-1">
                            <span class="fw-bold text-dark" title="{{ lo.description }}">
                                {{ lo.code }} 
                                <span class="text-muted fw-normal ms-1">- {{ lo.description|truncatechars:30 }}</span>
                            </span>
                            <span class="fw-bold text-{{ lo.color }}">%{{ lo.score }}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-{{ lo.color }}" role="progressbar" 
                                 style="width: {{ lo.score }}%" 
                                 aria-valuenow="{{ lo.score }}" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center small">Henüz veri oluşmadı.</p>
                    {% endfor %}
                </div>
                </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // 1. RADAR GRAFİĞİ
    const radarCtx = document.getElementById('radarChart').getContext('2d');
    const radarLabels = {{ radar_labels|safe }};
    const radarData = {{ radar_data|safe }};

    new Chart(radarCtx, {
        type: 'radar',
        data: {
            labels: radarLabels,
            datasets: [{
                label: 'Yetkinlik Seviyesi (%)',
                data: radarData,
                fill: true,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgb(54, 162, 235)',
                pointBackgroundColor: 'rgb(54, 162, 235)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(54, 162, 235)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: { display: true },
                    suggestedMin: 0,
                    suggestedMax: 100,
                    grid: { color: '#e5e7eb' },
                    pointLabels: { font: { size: 12, weight: 'bold' } }
                }
            },
            plugins: { legend: { display: false } }
        }
    });

    // 2. SINIF KIYASLAMASI (BAR CHART)
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    const examLabels = {{ exam_labels|default:"[]"|safe }};
    const myScores = {{ my_scores|default:"[]"|safe }};
    const classAverages = {{ class_averages|default:"[]"|safe }};

    new Chart(comparisonCtx, {
        type: 'bar',
        data: {
            labels: examLabels,
            datasets: [
                {
                    label: 'Benim Notum',
                    data: myScores,
                    backgroundColor: '#4f46e5', // Koyu Mavi
                    borderRadius: 5,
                    barPercentage: 0.6
                },
                {
                    label: 'Sınıf Ortalaması',
                    data: classAverages,
                    backgroundColor: '#e5e7eb', // Gri
                    borderRadius: 5,
                    barPercentage: 0.6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: { borderDash: [2, 4] }
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
</script>
{% endblock %}